services:
  trainer:
    build: .
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - WANDB_API_KEY=${WANDB_API_KEY:-}
    volumes:
      - ./data:/app/data
      - ./checkpoints:/app/checkpoints
      - ./reports:/app/reports
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  trainer-ddp:
    build: .
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
      - WANDB_API_KEY=${WANDB_API_KEY:-}
    entrypoint: ["torchrun", "--nproc_per_node=2", "-m"]
    command: ["src.main", "--config", "configs/training.yaml", "--distributed"]
    volumes:
      - ./data:/app/data
      - ./checkpoints:/app/checkpoints
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  benchmark:
    build: .
    runtime: nvidia
    environment:
      - NVIDIA_VISIBLE_DEVICES=all
    command: ["src.benchmarks.run_benchmark", "--output", "reports/benchmark.md"]
    volumes:
      - ./data:/app/data
      - ./reports:/app/reports
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
